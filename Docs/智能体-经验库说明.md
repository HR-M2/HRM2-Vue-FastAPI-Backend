# 智能体经验库说明

## 概述

经验库是 HRM2 系统的核心 RAG（检索增强生成）组件，用于存储 HR 反馈提炼的评估经验，并在生成报告时自动检索相关经验注入到 LLM Prompt 中。

## 架构

```
HR反馈 → LLM提炼规则 → Embedding向量化 → 存入数据库
                                              ↓
查询构造 → Embedding粗召回 → Reranker精排 → 阈值过滤 → 注入Prompt
```

## 两阶段检索策略

### Stage 1: Embedding 粗召回

- **模型**: BAAI/bge-m3 (SiliconFlow API)
- **召回数量**: top_k × 2 = 10 条
- **相似度计算**: 余弦相似度
- **作用**: 从全库快速筛选语义相近的候选经验

### Stage 2: Reranker 精排

- **模型**: BAAI/bge-reranker-v2-m3 (SiliconFlow API)
- **精排数量**: top_k = 5 条
- **相关性阈值**: 0.2
- **作用**: 对候选经验进行精细排序，过滤不相关内容

### 降级策略

当 Reranker 未配置或调用失败时，自动降级为纯 Embedding 检索：
- 使用较高阈值 0.7 过滤
- 直接返回 Embedding 相似度最高的 top_k 条

## 参数配置

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `top_k` | 5 | 最终返回的经验数量 |
| `threshold` | 0.2 | Reranker 相关性阈值 |
| 粗召回数量 | 10 | Embedding 阶段取 top_k × 2 |
| 降级阈值 | 0.7 | Reranker 不可用时的 Embedding 阈值 |

## 查询构造

调用 `recall()` 时，`context` 参数使用简短格式：

```python
# 简历筛选
context = f"筛选报告 - 岗位: {position_title}"

# 面试报告
context = f"面试报告 - 岗位: {job_title}"

# 综合分析
context = f"综合分析 - 岗位: {position_title}"
```

## 调用位置

| 场景 | 文件 | 函数 |
|------|------|------|
| 简历筛选 | `app/api/v1/ai_services.py` | `run_screening_task()` |
| 面试报告 | `app/api/v1/ai_services.py` | `ai_generate_report()` |
| 综合分析 | `app/api/v1/ai_services.py` | `ai_comprehensive_analysis()` |
| 报告重生成 | `app/api/v1/feedback.py` | `_regenerate_*_report()` |

## 数据模型

### AgentExperience 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | str | 主键 |
| category | str | 类别: screening/interview/analysis |
| source_feedback | str | HR 原始反馈 |
| learned_rule | str | AI 提炼的通用规则 |
| context_summary | str | 触发经验的上下文摘要 |
| embedding | JSON | 文本向量 (List[float]) |
| created_at | datetime | 创建时间 |

## 环境配置

```env
# Embedding 配置
EMBEDDING_MODEL=BAAI/bge-m3
EMBEDDING_API_KEY=your-siliconflow-api-key
EMBEDDING_BASE_URL=https://api.siliconflow.cn/v1/embeddings

# Reranker 配置
RERANKER_MODEL=BAAI/bge-reranker-v2-m3
RERANKER_API_KEY=your-siliconflow-api-key
RERANKER_BASE_URL=https://api.siliconflow.cn/v1/rerank
```

## 核心代码

### ExperienceManager

位置: `app/agents/experience_manager.py`

```python
class ExperienceManager:
    async def learn(db, category, feedback, context) -> AgentExperience:
        """从 HR 反馈中学习经验"""
        # 1. LLM 提炼规则
        # 2. Embedding 向量化
        # 3. 存入数据库
    
    async def recall(db, category, context, top_k=5, threshold=0.2) -> List[AgentExperience]:
        """两阶段语义检索相关经验"""
        # 1. Embedding 粗召回 (top_k × 2)
        # 2. Reranker 精排 (top_k)
        # 3. 阈值过滤 (>= threshold)
    
    def format_experiences_for_prompt(experiences) -> str:
        """格式化经验为 Prompt 文本"""
```

## 效果验证

运行 RAG 效果测试：

```bash
pytest tests/ai/test_rag_effect.py -v -s
```

测试验证点：
1. **跨岗位借鉴**: Java/Python 后端能召回"后端通用"经验
2. **互相排除**: 厨师查询不会召回技术岗位经验
3. **无需预设分类**: Reranker 自动判断相关性

## 前端展示

经验库管理界面: `src/components/dev-tools/ExperienceManager.vue`

功能：
- 查看/筛选经验列表
- 手动添加经验规则
- 补全缺失向量
- 删除/清空经验

报告中展示引用的经验: `src/views/RecommendView.vue`
- 显示"本次评估参考了以下经验"
- 展示每条经验的规则和来源反馈
